name: Generar archivos JSON de acciones

on:
  workflow_dispatch:
  push:
    paths:
      - 'datos_bmv/*.csv'
      - 'datos_us/*.csv'
      - 'csv_to_json.py'

jobs:
  procesar-y-verificar:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias (si hay)
        run: |
          pip install -r requirements.txt || true

      - name: Ejecutar script de procesamiento
        run: python "csv_to_json.py"

      - name: Verificar tamaño de archivos JSON
        run: |
          MAX_BYTES=$((100 * 1024 * 1024))
          FILE1="datos_json/bmv_stock_data.json"
          FILE2="datos_json/us_stock_data.json"

          for FILE in "$FILE1" "$FILE2"; do
            SIZE=$(stat --format=%s "$FILE")
            if [ "$SIZE" -gt "$MAX_BYTES" ]; then
              echo "❌ El archivo $FILE excede los 100 MB (${SIZE} bytes)"
              exit 1
            else
              echo "✅ $FILE tiene un tamaño aceptable (${SIZE} bytes)"
            fi
          done

      - name: Configurar Git
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'

      - name: Hacer commit y push si hubo cambios
        run: |
          git add datos_json/*.json
          if git diff --cached --quiet; then
            echo "No hay cambios que hacer commit."
          else
            git commit -m "Actualizar archivos JSON de acciones"
            git push
          fi
